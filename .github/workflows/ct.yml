name: Continuous Training (CT)

on:
  schedule:
    # Cada 10 minutos (UTC)
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  continuous-training:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.11"
      # Puedes controlar qué tipo de drift simular:
      # data, model o both
      DRIFT_SCENARIO: "both"

    steps:
      # 0) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Setup Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 2) Instalar dependencias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "Dependencias instaladas: scikit-learn, optuna, mlflow, etc."

      # 3) Generar batch de producción (simular data/model drift)
      - name: Generar datos de producción (simular drift)
        env:
          DRIFT_SCENARIO: ${{ env.DRIFT_SCENARIO }}
        run: |
          python -m src.simulate_production_data

      # 4) Detectar drift y decidir si reentrenar
      - name: Detectar data drift y model drift
        id: detect
        run: |
          python -m src.detect_drift

      # 5) PREPROCESAMIENTO (solo si retrain = true)
      - name: Preprocesamiento de datos (CT)
        if: steps.detect.outputs.retrain == 'true'
        run: |
          python -m src.data_prep

      # 6) ENTRENAMIENTO (solo si retrain = true)
      # Incluye: Optuna hyperparameter optimization + Stratified K-Fold CV
      - name: Entrenamiento del modelo (CT con Optuna + CV)
        if: steps.detect.outputs.retrain == 'true'
        env:
          OPTUNA_N_TRIALS: 50
          OPTUNA_METRIC: "auc"
        run: |
          echo "Reentrenamiento con optimización de hiperparámetros..."
          echo "Usando Optuna para encontrar mejores hiperparámetros"
          python -m src.train

      # 7) EVALUACIÓN (solo si retrain = true)
      - name: Evaluación del modelo (CT)
        if: steps.detect.outputs.retrain == 'true'
        run: |
          python -m src.evaluate

      # 8) Log informativo si NO hubo retraining
      - name: No retrain necesario
        if: steps.detect.outputs.retrain != 'true'
        run: |
          echo "No se detectó drift significativo. No se ejecuta reentrenamiento en este ciclo."
